<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Premier programme WebGL</title>
        <link rel="stylesheet" href="style.css"/>
    </head>
    <body>
        <div id="controls">
            <p>A - Axis helper</p>
            <p>G - Grid helper</p>
            <p>N - Drones names</p>
            <p>R - Ground lines (yellow)</p>
            <p>T - Trajectory lines (cyan)</p>
            <p>F - Fullscreen</p>
            <p>P - Play/Pause animation</p>
        </div>
        <div id="info">
            <p>Drone name :</p>
            <p>Red text = too fast</p>
            <p>Red background = too close</p>
        </div>
        <!--THREE JS-->
        <script src="three.js-master/build/three.js"></script>
        <!--CONTROLS-->
        <script src="three.js-master/examples/js/controls/OrbitControls.js"></script>
        <!--RENDERERS-->
        <script src="three.js-master/examples/js/renderers/CSS2DRenderer.js"></script>
        <!--LOADERS-->
        <script src="three.js-master/examples/js/loaders/OBJLoader.js"></script>
        <script src="three.js-master/examples/js/loaders/MTLLoader.js"></script>
        <!--LIBS-->
        <script src="three.js-master/examples/js/libs/stats.min.js"></script>
        <!--JQUERY-->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

        <script>
            /*****      Scene       *****/
            var scene = new THREE.Scene();
            scene.background = new THREE.Color("rgb(0, 0, 0)");

            /*****      Camera      *****/
            var camera = new THREE.PerspectiveCamera( 45, window.innerWidth/window.innerHeight, 0.1, 10000 );
            camera.position.set( 0, 0, 8 );

            /*****      Renderers       *****/
            var renderer = new THREE.WebGLRenderer( {antialias: true} );
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFShadowMap;
            document.body.appendChild( renderer.domElement );

            var labelRenderer = new THREE.CSS2DRenderer();
            labelRenderer.setSize( window.innerWidth, window.innerHeight );
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            document.body.appendChild( labelRenderer.domElement );

            /*****      Timeline      *****/
            var div = document.createElement('div');
            div.setAttribute("class", "slidecontainer");

            var range = document.createElement("input");
            range.setAttribute("type", "range");
            range.setAttribute("min", "0");
            range.setAttribute("max", "0");
            range.setAttribute("value", "0");
            range.setAttribute("class", "slider");

            div.appendChild(range);
            document.body.appendChild(div);

            /*****      Drones      *****/
            var droneData;
            var drones = [];
            var trajectoryLines = [];
            var groundLines = [];
            var labels = [];
            var endFrame = 0;
            var framerate = 0;
            var times = [[]];
            var values = [[]];
            var keyFrameTracks = [];
            var animationClips = [];
            var animationMixers = [];
            var actions = [];

            var isPlaying = false;

            $(document).ready(function(){
                $.getJSON("waypoints.json", function(data){
                    droneData = data;
                    var objLoader = new THREE.OBJLoader();
                    objLoader.setPath( 'objets/' );
                    objLoader.load( 'drone.obj', function ( object ) {
                        object.position.set(0,0,0);
                        object.rotation.set(0,0,0);
                        framerate = droneData.framerate;
                        for (i = 0; i < droneData.drones.length; i++) {
                            var newDrone = object.clone();
                            newDrone.position.set(droneData.drones[i].waypoints[0].position.lng_X/100, droneData.drones[i].waypoints[0].position.alt_Y/100, droneData.drones[i].waypoints[0].position.lat_Z/100);
                            newDrone.scale.set(0.1, 0.1, 0.1);
                            drones.push(newDrone);
                            scene.add(newDrone);

                            var droneTimes = [];
                            var droneValues = [];
                            for (j = 0; j < droneData.drones[i].waypoints.length; j++) {
                                droneTimes.push(droneData.drones[i].waypoints[j].frame);
                                droneValues.push(droneData.drones[i].waypoints[j].position.lng_X/100);
                                droneValues.push(droneData.drones[i].waypoints[j].position.alt_Y/100);
                                droneValues.push(droneData.drones[i].waypoints[j].position.lat_Z/100);
                            }

                            times.push(droneTimes);
                            values.push(droneValues);
                            var positionKF = new THREE.VectorKeyframeTrack('.position', droneTimes, droneValues);
                            keyFrameTracks.push([positionKF]);
                            animationClips.push(new THREE.AnimationClip('default', -1, keyFrameTracks[i]));
                            animationMixers.push(new THREE.AnimationMixer(drones[i]));
                            actions.push((animationMixers[i]).clipAction(animationClips[i]));
                            actions[i].play();

                            var div = document.createElement( 'div' );
                            div.className = 'label';
                            div.textContent = 'DRONE ' + droneData.drones[i].id;
                            div.style.marginTop = '-1em';
                            div.style.zIndex = '1';
                            var label = new THREE.CSS2DObject( div );
                            label.position.set( 0, 0, 0 );
                            newDrone.add( label );
                            labels.push(div);

                            var trajectoryPoints = [];
                            var groundPoints = [];
                            for(j = 0; j < droneData.drones[i].waypoints.length; j++){
                                trajectoryPoints.push( new THREE.Vector3(droneData.drones[i].waypoints[j].position.lng_X/100, droneData.drones[i].waypoints[j].position.alt_Y/100, droneData.drones[i].waypoints[j].position.lat_Z/100) );
                                if(droneData.drones[i].waypoints[j].frame > endFrame) endFrame = droneData.drones[i].waypoints[j].frame;
                            }
                            groundPoints.push( new THREE.Vector3(drones[i].position.x, 0, drones[i].position.z) );
                            groundPoints.push( new THREE.Vector3(drones[i].position.x, drones[i].position.y, drones[i].position.z) );
                            var trajectorymaterial = new THREE.LineBasicMaterial( { color: 0x00ffff } );
                            var trajectorygeometry = new THREE.BufferGeometry().setFromPoints( trajectoryPoints );
                            var trajectoryLine = new THREE.Line( trajectorygeometry, trajectorymaterial );
                            var groundmaterial = new THREE.LineBasicMaterial( { color: 0xffff00 } );
                            var groundgeometry = new THREE.BufferGeometry().setFromPoints( groundPoints );
                            var groundLine = new THREE.Line( groundgeometry, groundmaterial );
                            trajectoryLines.push(trajectoryLine);
                            groundLines.push(groundLine);
                            scene.add(trajectoryLine);
                            scene.add(groundLine);
                        }
                        range.setAttribute("max", endFrame);
                        isPlaying = true;
                    });
                });
               
            });

            /*****      Ground      *****/
            var texture = new THREE.TextureLoader().load( 'sol.jpg' );
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set( 5, 5 );
            var geometry = new THREE.PlaneGeometry( 100, 100, 32 );
            var material = new THREE.MeshBasicMaterial( {color: 0xffff00,
                                                        side: THREE.DoubleSide,
                                                        specular: 0xffffff,
                                                        shininess: 40,
                                                        map: texture } );
            var plane = new THREE.Mesh( geometry, material );
            plane.rotation.set(-Math.PI / 2, 0, 0);
            plane.castShadow = false;
            plane.receiveShadow = true;
            scene.add( plane );

            /*****      Lights      *****/
            var ambientLight = new THREE.AmbientLight( 0x555555 ) ;
            scene.add( ambientLight );

            var directionalLight = new THREE.DirectionalLight( 0xffffff );
            directionalLight.position.set( 0.5, 1, 0.25 );
            directionalLight.castShadow = true;
            directionalLight.shadow.width = 512;
            directionalLight.shadow.height = 512;
            directionalLight.shadow.camera.top = 2;
            directionalLight.shadow.camera.bottom = -2;
            directionalLight.shadow.camera.left = -2.5;
            directionalLight.shadow.camera.right = 2.5;
            directionalLight.shadow.camera.far = 5.75;
            directionalLight.shadow.bias = -0.025;

            scene.add( directionalLight );

            /*****      Helpers     *****/
            var axesHelper = new THREE.AxesHelper( 5 );
            scene.add( axesHelper );

            var size = 20;
            var divisions = 10;
            var gridHelper = new THREE.GridHelper( size, divisions );
            scene.add( gridHelper );

            
            /*****      Skybox      *****/
            var textures_skybox = [
                "skybox/xp.jpg", "skybox/xn.jpg",
                "skybox/yp.jpg", "skybox/yn.jpg",
                "skybox/zp.jpg", "skybox/zn.jpg",
            ];
            scene.background = new THREE.CubeTextureLoader().load( textures_skybox );

            /*****      Controls      *****/
            var controls = new THREE.OrbitControls( camera, labelRenderer.domElement )

            /*****      Animate      *****/
            var clock = new THREE.Clock();
            var valueChanged = false;
            var newValue = -1;
            var oldValue = 0;
            var rayon = 1;
            function animate() {
                var oldPositions = []

                for(var i = 0; i < drones.length; i++){
                    oldPositions.push(new THREE.Vector3(drones[i].position.x, drones[i].position.y, drones[i].position.z));
                }
                requestAnimationFrame( animate );

                controls.update();

                if(actions.length > 0){
                    oldValue = actions[0].time;
                    range.value = actions[0].time;
                }
                
                var delta = clock.getDelta();
                for (var i = 0; i < animationMixers.length; i++) {
                    if(valueChanged){
                        animationMixers[i].update((Math.abs(oldValue-newValue))*delta*framerate);
                    }else{
                        animationMixers[i].update(delta*framerate);
                    }
                }
                if(valueChanged){ 
                    valueChanged = false;
                    newValue = -1;
                }

                for (var i = 0; i < groundLines.length; i++) {
                    groundLines[i].geometry.attributes.position.array[0] = drones[i].position.x;
                    groundLines[i].geometry.attributes.position.array[1] = 0;
                    groundLines[i].geometry.attributes.position.array[2] = drones[i].position.z;

                    groundLines[i].geometry.attributes.position.array[3] = drones[i].position.x;
                    groundLines[i].geometry.attributes.position.array[4] = drones[i].position.y;
                    groundLines[i].geometry.attributes.position.array[5] = drones[i].position.z;
                    groundLines[i].geometry.attributes.position.needsUpdate = true;
                }

                for(var i = 0; i < drones.length; i++){
                    var isColliding = false;
                    for(var j = 0; j < drones.length; j++){
                        if(drones[i].position.distanceTo(drones[j].position) < rayon && drones[i] != drones[j]){
                            isColliding = true;
                        }
                    }
                    if(isColliding){
                        labels[i].style.backgroundColor = 'red';
                    } else {
                        labels[i].style.backgroundColor = 'rgba(0,0,0,0.5)';
                    }
                }

                renderer.render( scene, camera );
                labelRenderer.render( scene, camera );

                for(var i = 0; i < drones.length; i++){
                    if(drones[i].position.distanceTo(oldPositions[i]) > 1){
                        labels[i].style.color = 'red';
                    } else {
                        labels[i].style.color = 'white';
                    }
                }

            };
            animate();

            /*****      KeyEvents       *****/
            var fullscreen = true;
            window.addEventListener("keydown", function (event) {
                switch (event.key) {
                    case "a":
                        axesHelper.visible = !axesHelper.visible;
                        break;
                    case "g":
                        gridHelper.visible = !gridHelper.visible;
                        break;
                    case "f":
                        if(fullscreen){
                            closeFullscreen();
                            fullscreen = false;
                        } else {
                            openFullscreen();
                            fullscreen = true;
                        }
                        break;
                    case "t":
                        for (i = 0; i < trajectoryLines.length; i++) {
                            trajectoryLines[i].visible = !trajectoryLines[i].visible;
                        }
                        break;
                    case "r":
                        for (i = 0; i < groundLines.length; i++) {
                            groundLines[i].visible = !groundLines[i].visible;
                        }
                        break;
                    case "n":
                        for (i = 0; i < labels.length; i++) {
                            if(labels[i].style.visibility == "hidden"){
                                labels[i].style.visibility = "visible";
                            } else {
                                labels[i].style.visibility = "hidden";
                            }
                        }
                        break;
                    case "p":
                        if(!isPlaying){
                            for (i = 0; i < actions.length; i++) {
                                actions[i].paused = false;
                            }
                            isPlaying = true;
                        } else {
                            for (i = 0; i < actions.length; i++) {
                                actions[i].paused = true;
                            }
                            isPlaying = false;
                        }
                    default:
                        return;
                }
                event.preventDefault();
            }, true);

            range.addEventListener('input', function () {
                valueChanged = true;
                newValue = range.value;
            }, false);

            /*****      ResizeEvent     *****/
            window.addEventListener( 'resize', onWindowResize, false );
            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize( window.innerWidth, window.innerHeight );
                labelRenderer.setSize( window.innerWidth, window.innerHeight );
            }

            /*****      Fullscreen      *****/
            var elem = document.documentElement;
            function openFullscreen() {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            }

            function closeFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
            }
        </script>
    </body>
</html>